<!DOCTYPE html>
<html>
<head>
  <title>click_async_test.html</title>
  <script src="../webdriver-bootstrap.js"></script>

  <script src="deps.js" type="text/javascript"></script>
  <script type="text/javascript">
    goog.require('bot.action');
    goog.require('bot.locators');
    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.events.EventType');
    goog.require('goog.testing.jsunit');
  </script>
</head>
<body>
  <iframe id="iframe" src="testdata/click_iframe.html">

  </iframe>
  <script type="text/javascript">
    /**
    * This test is in a separate file because AsyncTestCase seems to conflict
    * with the existing tests.
    */

    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();
    var findElement = bot.locators.findElement;


    function testClickOnAnAbsoluteAnchorInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var iframeDoc = goog.dom.getFrameContentDocument(iframe);
      var clickTarget = findElement({'id': 'iframeClickTarget'}, iframeDoc);
      var targetHref = buildAbsoluteUrl('/testdata/click_iframe.html');

      // As the iframe loads asyncronously we need to wait to check our
      // if the url matches the expected one.
      goog.events.listen(iframe, 'load', function() {
        assertContains(targetHref, iframeWindow.document.location.href);
        asyncTestCase.continueTesting();
      });

      clickTarget.href = targetHref;
      bot.action.click(clickTarget);

      asyncTestCase.waitForAsync('Waiting for iframe to load');
    }

    function buildAbsoluteUrl(url) {
      var loc = location.href;
      return loc.substring(0, loc.lastIndexOf('/')) + url;
    }
  </script>

</body>
</html>
