<!DOCTYPE html>
<html>
<head>
  <title>click_test.html</title>
  <script src="../webdriver-bootstrap.js"></script>
  <script src="deps.js"></script>
  <script type="text/javascript">
    goog.require('bot.action');
    goog.require('goog.debug.DivConsole');
    goog.require('goog.debug.Logger');
    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.events.EventType');
    goog.require('goog.style');
    goog.require('goog.testing.jsunit');
  </script>
  <script type="text/javascript">


    var clicker;
    var clickLocation;
    var divConsole;
    var log = goog.debug.Logger.getLogger('click_test');

    function resetClicker() {
      divConsole.clear();
      goog.style.showElement(clicker, true);
      goog.events.removeAll(clicker);
      goog.events.listen(clicker,
          [goog.events.EventType.MOUSEOVER,
           goog.events.EventType.MOUSEMOVE,
           goog.events.EventType.MOUSEDOWN,
           goog.events.EventType.MOUSEUP,
           goog.events.EventType.CLICK,
           goog.events.EventType.BLUR,
           goog.events.EventType.FOCUS],
          function(e) {
            log.info(e.type);
          });
      blurClicker();
    }

    function blurClicker() {
      clicker.blur();
      goog.dom.$('focusSink').focus();
    }

    function hideClickerOn(eventType) {
      goog.events.listen(clicker, eventType, function() {
        goog.style.showElement(clicker, false);
      });
    }

    function setUp() {
      blurClicker();
    }

    function tearDown() {
      resetClicker();
    }


    function testShouldNotBeAbleToClickOnAnElementThatIsNotShown() {
      var noHeightElement = goog.dom.$('noHeight');
      var threw = false;
      try {
        bot.action.click(noHeightElement);
      } catch (ex) {
        assertEquals(bot.ErrorCode.ELEMENT_NOT_VISIBLE, ex.code);
        threw = true;
      }
      assertTrue(threw);
    }


    function testShouldClickInTheMiddleOfAnElement() {
      goog.events.listen(clicker, goog.events.EventType.MOUSEUP, function(e) {
        assertEquals(e.clientX, clickLocation.left + (clickLocation.width / 2));
        assertEquals(e.clientY, clickLocation.top + (clickLocation.height / 2));
      });

      bot.action.click(clicker);
    }


    // TODO(user): This test demands that firefox has focus
    function xtestShouldFocusOnAnElementBeforeFinishingClickSequence() {
      // This test will fail if the browser is Firefox and it does not have 
      // focus (when launching the tests on Mac, this is the case by default).
      var focused = false;
      clicker.blur();
      goog.dom.$('noHeight').focus();

      goog.events.listen(clicker, goog.events.EventType.FOCUS, function() {
        focused = true;
      });

      bot.action.click(clicker);
      assertTrue(focused);
    }


    function testShouldGenerateTheCorrectClickSequence() {
      var expectedEvents = [
        goog.events.EventType.MOUSEOVER,
        goog.events.EventType.MOUSEMOVE,
        goog.events.EventType.MOUSEDOWN,
        goog.events.EventType.MOUSEUP,
        goog.events.EventType.CLICK];
      var events = [];
      goog.events.listen(clicker, expectedEvents, function(e) {
        events.push(e.type);
      });
      bot.action.click(clicker);
      assertArrayEquals(expectedEvents, events);
    }

    // http://code.google.com/p/selenium/issues/detail?id=1207
    function testShouldRespondCorrectlyIfElementIsHiddenMidClickSequence() {
      function runTest(expectedEvents) {
        resetClicker();

        var hideOn = expectedEvents[expectedEvents.length - 1];
        var events = [];
        goog.events.listen(clicker,
            [goog.events.EventType.MOUSEOVER,
             goog.events.EventType.MOUSEMOVE,
             goog.events.EventType.MOUSEDOWN,
             goog.events.EventType.FOCUS,
             goog.events.EventType.MOUSEUP,
             goog.events.EventType.CLICK],
            function(e) {
              events.push(e.type);
            });
        hideClickerOn(hideOn);

        assertTrue('Should start shown', bot.dom.isShown(clicker));
        bot.action.click(clicker);
        assertFalse('Should end not shown', bot.dom.isShown(clicker));
        assertArrayEquals(expectedEvents, events);
      }

      runTest([goog.events.EventType.MOUSEOVER]);
      runTest([goog.events.EventType.MOUSEOVER,
               goog.events.EventType.MOUSEMOVE]);
      runTest([goog.events.EventType.MOUSEOVER,
               goog.events.EventType.MOUSEMOVE,
               goog.events.EventType.MOUSEDOWN]);
      runTest([goog.events.EventType.MOUSEOVER,
               goog.events.EventType.MOUSEMOVE,
               goog.events.EventType.MOUSEDOWN,
               goog.events.EventType.FOCUS]);
      runTest([goog.events.EventType.MOUSEOVER,
               goog.events.EventType.MOUSEMOVE,
               goog.events.EventType.MOUSEDOWN,
               goog.events.EventType.FOCUS,
               goog.events.EventType.MOUSEUP]);
      runTest([goog.events.EventType.MOUSEOVER,
               goog.events.EventType.MOUSEMOVE,
               goog.events.EventType.MOUSEDOWN,
               goog.events.EventType.FOCUS,
               goog.events.EventType.MOUSEUP,
               goog.events.EventType.CLICK]);
    }
  </script>
</head>
<body>
  <form action="javascript:void(0)">
    <label for="focusSink">Focus sink:</label><input id="focusSink" type="text"/><br/>
    <label for="clicker">Click me:</label><input id="clicker" type="checkbox"/><br/>
    <div id="log"></div>
    <script>
clicker = goog.dom.$('clicker');
clickLocation = goog.style.getBounds(clicker);

divConsole = new goog.debug.DivConsole(goog.dom.$('log'));
divConsole.setCapturing(true);
    </script>
  </form>
  <div id="noHeight" style="height:0; line-height:0;">&nbsp;</div>
</body>
</html>
