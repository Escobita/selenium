<!DOCTYPE html>
<html>
<head>
  <title>click_async_test.html</title>
  <script src="test_bootstrap.js"></script>
  <script type="text/javascript">
    goog.require('bot.action');
    goog.require('bot.locators');
    goog.require('goog.Uri');
    goog.require('goog.dom');
    goog.require('goog.events');
    goog.require('goog.events.EventType');
    goog.require('goog.testing.AsyncTestCase');
    goog.require('goog.testing.jsunit');
    goog.require('goog.userAgent');
    goog.require('goog.userAgent.product');
  </script>
</head>
<body>

  <a id="clickTarget">Click me!</a>
  <a id="clickTargetWithAChild">Click <strong>the nested</strong> element</a>
  <iframe id="iframe" src="testdata/click_iframe.html">
  </iframe>
  <label for="clicker">Click me:</label><input id="clicker" type="checkbox" /><br/>

  <script type="text/javascript">
    var findElement = bot.locators.findElement; 
    var asyncTestCase = goog.testing.AsyncTestCase.createAndInstall();

    function assertSoon(fn) {
      asyncTestCase.waitForAsync('Waiting for click');
      window.setTimeout(function() {
        asyncTestCase.continueTesting();
        fn();
      }, 10);
    }

    function testClickCorrectlyResolvesEmptyFragment() {
      // A bug in the closure goog.Uri module once prevented this from working.
      var clickTarget = findElement({id: 'clickTarget'});
      // Make sure no other event listeners are interfering.
      goog.events.removeAll(clickTarget);

      clickTarget.href = '#';
      bot.action.click(clickTarget);
      assertSoon(function() {
        var windowHref = window.location.href;
        assertEquals('#', windowHref.charAt(windowHref.length - 1));
      });
    }

    function testClickExecutesDefaultHandler() {
      var clickTarget = findElement({id: 'clickTarget'});
      // Make sure no other event listeners are interfering.
      goog.events.removeAll(clickTarget);

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = '#' + Math.random();
      clickTarget.href = targetHref;

      bot.action.click(clickTarget);
      assertSoon(function() {
        assertEquals(targetHref, window.location.hash);
      })
    }

    function testClickOnANestedElementExecutesDefaultHandler() {
      var parent = findElement({id: 'clickTargetWithAChild'});

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = '#' + Math.random();
      parent.href = targetHref;

      var clickTarget = goog.dom.getFirstElementChild(parent);
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertEquals(targetHref, window.location.hash);
      });
    }

    function testClickOnAnAbsoluteServerPathAnchorInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var domHelper = goog.dom.getDomHelper(iframeWindow);
      var clickTarget = domHelper.getElement('iframeClickTarget');

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var testPath = window.location.pathname;
      var targetHref = testPath.substring(0, testPath.lastIndexOf('/')) +
          '/testdata/click_iframe.html#' + Math.random();
      clickTarget.href = targetHref;
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertContains(targetHref, iframeWindow.location.href);
      });
    }

    function testClickOnAnAbsoluteUrlInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var domHelper = goog.dom.getDomHelper(iframeWindow);
      var clickTarget = domHelper.getElement('iframeClickTarget');

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = goog.Uri.resolve(iframeWindow.location,
          '#' + Math.random()).toString();

      // Let's make sure it is an absolute url.
      assertContains('http', targetHref);

      clickTarget.href = targetHref;
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertEquals(targetHref, iframeWindow.location.href);
      });
    }

    function testClickOnAnHashOnlyAnchorInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var domHelper = goog.dom.getDomHelper(iframeWindow);
      var clickTarget = domHelper.getElement('iframeClickTarget');

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = '#' + Math.random();
      clickTarget.href = targetHref;
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertEquals(targetHref, iframeWindow.location.hash);
      });
    }

    function testClickOnAnNestedElementInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var domHelper = goog.dom.getDomHelper(iframeWindow);
      var parent = domHelper.getElement('iframeClickTargetWithAChild');
      var clickTarget = goog.dom.getFirstElementChild(parent);

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = '#' + Math.random();
      parent.href = targetHref;
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertEquals(targetHref, iframeWindow.location.hash);
      });
    }

    function testClickOnAnRelativeServerPathAnchorInAnIframeExecutesDefaultHandler() {
      var iframe = findElement({id: 'iframe'});
      var iframeWindow = goog.dom.getFrameContentWindow(iframe);
      var domHelper = goog.dom.getDomHelper(iframeWindow);
      var clickTarget = domHelper.getElement('iframeClickTarget');

      // Use a random value as we don't want to keep an old
      // misleading hash in the url.
      var targetHref = 'click_iframe.html#' + Math.random();
      clickTarget.href = targetHref;
      bot.action.click(clickTarget);
      assertSoon(function() {
        assertContains(targetHref, iframeWindow.location.href);
      });
    }

    function testShouldClickTheCoordOfAnElement() {
      var clicker = findElement({id: 'clicker'});

      goog.events.removeAll(clicker);
      goog.events.listen(clicker, goog.events.EventType.CLICK, function(e) {
        asyncTestCase.continueTesting();

        var clickedXY = {x: e.clientX, y: e.clientY};
        // Calculate the coordinates that should be clicked according to the
        // top left corner of the browser's content area
        var clickPos = goog.style.getClientPosition(clicker);
        assertFloorsEquals(clickedXY.x, clickPos.x + coord.x);
        assertFloorsEquals(clickedXY.y, clickPos.y + coord.y);
      });

      var coord = new goog.math.Coordinate(3, 3);
      asyncTestCase.waitForAsync('Waiting for click');
      bot.action.click(clicker, coord);
    }

    function assertFloorsEquals(expected, actual) {
      assertEquals(Math.floor(expected), Math.floor(actual));
    }
  </script>
</body>
</html>
