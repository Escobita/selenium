<!DOCTYPE html>
<html>
<head>
  <title>abstractcommandprocessor_test.html</title>
  <script src="webdriver-bootstrap.js"></script>
  <script src="testbase.js"></script>
  <script>

    function assertArraysEqual(expected, actual) {
      assertTrue('Expected is not an array', goog.isArray(expected));
      assertTrue('Actual is not an array', goog.isArray(actual));
      for (var i = 0; i < expected.length; i++) {
        assertEquals('Differenece at index ' + i, expected[i], actual[i]);
      }
    }

    function assertMapsEqual(expected, actual) {
      expected = new goog.structs.Map(expected);
      actual = new goog.structs.Map(actual);

      // Test keys are equal
      assertArraysEqual(expected.getKeys(), actual.getKeys());

      // Test key values are equal
      for (var i = 0, key; key = expected.getKeys()[i]; i++) {
        var expectedValue = expected.get(key);
        var actualValue = actual.get(key);
        if (goog.isArray(expectedValue)) {
          assertArraysEqual(expectedValue, actualValue);
        } else if (goog.isNumber(expectedValue) || goog.isBoolean(expectedValue) ||
                   goog.isString(expectedValue) || goog.isFunction(expectedValue)) {
          assertEquals('Difference for key "' + key + '"', expectedValue, actualValue);
        } else {
          assertMapsEqual(expectedValue, actualValue);
        }
      }
    }


    function testShouldResolvePrimitiveParamsToThemselves() {
      var command = {
        parameters: {
          number: 123,
          alphabet: 'abc',
          boolean1: true,
          boolean2: false,
          undef: undefined,
          nil: null,
          floating: 456.789,
          func: goog.nullFunction
        }
      };
      var expected = goog.object.map(command.parameters, function(value) {
        return value;
      });
      webdriver.AbstractCommandProcessor.resolveFutureParams_(command);
      assertMapsEqual(expected, command.parameters);
    }


    function testShouldResolveFutureParametersToTheirValue() {
      var command = {
        parameters: {
          future: new webdriver.Future(null)
        }
      };
      command.parameters.future.setValue('abc123');
      webdriver.AbstractCommandProcessor.resolveFutureParams_(command);
      assertMapsEqual({future: 'abc123'}, command.parameters)
    }


    function testShouldResolveFuturesEmbeddedInRecordObjectsToTheirValue() {
      var command = {
        parameters: {
          record: {future: new webdriver.Future(null)}
        }
      };
      command.parameters.record.future.setValue('abc123');
      webdriver.AbstractCommandProcessor.resolveFutureParams_(command);
      assertMapsEqual({
        record: {
          future: 'abc123'
        }
      }, command.parameters);
    }

    function testShouldResolveFuturesInAnArrayToTheirValue() {
      var command = {
        parameters: {
          array: [new webdriver.Future(null), new webdriver.Future(null)]
        }
      };
      command.parameters.array[0].setValue('abc123');
      command.parameters.array[1].setValue('456def');
      webdriver.AbstractCommandProcessor.resolveFutureParams_(command);
      assertMapsEqual({
        array: ['abc123', '456def']
      }, command.parameters);
    }
  </script>
</head>
<body>
</body>
</html>
