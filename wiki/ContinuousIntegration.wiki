#summary Details of Selenium's continuous integration setup

= General architecture =

We have a number of Google Compute Engine virtual machines running Ubuntu, currently hosted at {0..29}.sci.illicitonion.com - they have publicly addressable DNS set up to point [ab].{0..29}.sci.illicitonion.com pointing at them as well, so that cookie tests can do subdomain lookups.

One of these machines, sci.illicitonion.com, is running jenkins.  If you want a login on jenkins, get in touch with dawagner.  The Build All Java job polls svn for changes, and does the following:
  * Pings http://selenium-ci.jaribakken.com/build to let it know a build is happening
  * Does a clean build of the 'release' target, any tests which are going to be run, and any artifacts (e.g. the IEDriverServer executable) which will be required to run those tests
  * Tars up the entire built working directory and publishes it to http://sci.illicitonion.com/selenium-trunk-r${REVISION}.tgz - this is used later by test runs
  * Publishes the selenium-server-standalone jar to http://sci.illicitonion.com/selenium-server-standalone-r${REVISION}.tgz - this is copied down directly by [http://saucelabs.com SauceLabs] when running tests.
  * Zips up the IEDriverServer and publishes it to http://sci.illicitonion.com/IEDriverServer-Win32-r${REVISION}.zip - this is copied down directly by [http://saucelabs.com SauceLabs] to run IE tests
  * Publishes an updated ignores.json to http://sci.illicitonion.com/jarib/ignores.json
This machine is backed by a 1TB persistent disk, which can hold many build artifacts, but they should be cleared out occasionally (particularly when moving disk between zones).

When this build is successful, it triggers downstream builds for each OS/browser/test combination we care about.  It also triggers a downstream clean build to ensure our maven poms are still in order ("Maven build").

Apart from "Maven build" which runs on the same build node as the compile (a beefy, 8-CPU machine with 32GB RAM), all downstream builds run on separate build nodes.

The downstream builds are configured using environment variables, as per the [https://code.google.com/p/selenium/source/browse/trunk/java/client/test/org/openqa/selenium/testing/drivers/SauceDriver.java SauceDriver] class.  The downstream builds download the selenium-trunk tar from the build master, and then run tests (which should already have been compiled by the Build All Java rule).  Two of these downstream builds are special; "HtmlUnit Java Tests" and "Small Tests" just run headless locally.  The others use [http://saucelabs.com SauceLabs].

A note about networking: The build nodes are set up on an internal network 10.1.0/24, so network communication between them is incredibly fast and free.

When a non-headless browser test is running, the test-file servlet hosts the test files on ports determined by an environment variable (231${EXECUTOR_NUMBER} and 241${EXECUTOR_NUMBER} - EXECUTOR_NUMBER is currently always equal to 0).  The hostname used by tests is set by an environment variable ([ab].${NODE_NAME}.sci.illicitonion.com where NODE_NAME in {0..29}).  A browser is requested from [http://saucelabs.com SauceLabs] using our credentials (stored in jenkins-wide environment variables, set on the System Configuration page).  Jenkins is currently set to run three test-classes at a time in parallel, per test run, again on the System Configuration page.

The tests are run, and the results get notified to IRC.

Thanks to [http://saucelabs.com SauceLabs] and [http://cloud.google.com/products/compute-engine.html Google] for donating the infrastructure to run all of these tests.

= FAQ =

== I want to run my tests on Sauce like Jenkins does (my tests are failing on CI, but work fine on my machine!) ==

See the [Sauce SauceDriver] page

== I want to add a new browser (Firefox has released a new version!) ==

Jenkins doesn't have a great concept of templates.  I (dawagner) have some selenium scripts which automate the UI of Jenkins, to create new jobs using canned settings.  If you want to do it manually, here are roughly the steps to take: 
  * Find the most similar config(s) you want to copy.  If it's a new Firefox release, find the latest firefox (which should have roughly 6 builds associated with it: Javascript + Java {Windows,Linux} * {Native,Synthesized}
  * For each of those builds, create a New Job (menu on the left hand side of the home page, when logged in)
  * Name the job in the style of the others.  Select "Copy existing job", and enter the job you're copying.
  * Scroll through the job it's pre-populated.  Replace the version numbers, browser name, and any other details that need replacing.  For firefox updates, there are currently three places you should be replacing the number (the "browser_version" field, and two in the Build Execute Shell)
  * Save
  * Go to the Build All Java task, configure it, add your new build to the "Projects to build" field where there are many others listed.

If it's a firefox update, you probably also want to delete an existing build.

== Why doesn't Android run on the CI? ==

Android is pretty painful to set up.  Sauce now supports it, so we should try that out, when someone finds time.